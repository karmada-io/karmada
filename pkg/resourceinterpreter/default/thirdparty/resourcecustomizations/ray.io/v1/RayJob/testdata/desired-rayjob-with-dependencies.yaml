apiVersion: ray.io/v1
kind: RayJob
metadata:
  name: rayjob-with-dependencies
  namespace: default
spec:
  entrypoint: python /home/ray/samples/sample_code.py
  shutdownAfterJobFinishes: false
  submissionMode: K8sJobMode
  runtimeEnvYAML: |
    pip:
      - requests==2.26.0
    env_vars:
      counter_name: "test_counter"
  rayClusterSpec:
    rayVersion: '2.52.0'
    headGroupSpec:
      rayStartParams: {}
      template:
        spec:
          serviceAccountName: ray-head-sa
          imagePullSecrets:
          - name: registry-secret
          containers:
          - name: ray-head
            image: rayproject/ray:2.52.0
            ports:
            - containerPort: 6379
              name: gcs-server
            - containerPort: 8265
              name: dashboard
            resources:
              limits:
                cpu: "1"
                memory: 2Gi
            volumeMounts:
            - mountPath: /home/ray/samples
              name: code-sample
            - mountPath: /etc/config
              name: app-config
            - mountPath: /etc/tls
              name: tls-certs
            envFrom:
            - configMapRef:
                name: ray-env-config
            - secretRef:
                name: ray-env-secrets
            env:
            - name: API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-credentials
                  key: api-key
            - name: DB_CONFIG
              valueFrom:
                configMapKeyRef:
                  name: db-config
                  key: connection-string
          volumes:
          - name: code-sample
            configMap:
              name: ray-job-code-sample
          - name: app-config
            configMap:
              name: app-config
          - name: tls-certs
            secret:
              secretName: tls-certs
          - name: projected-vol
            projected:
              sources:
              - configMap:
                  name: projected-config
              - secret:
                  name: projected-secret
    workerGroupSpecs:
    - replicas: 2
      minReplicas: 1
      maxReplicas: 5
      groupName: small-group
      rayStartParams: {}
      template:
        spec:
          containers:
          - name: ray-worker
            image: rayproject/ray:2.52.0
            resources:
              limits:
                cpu: "1"
                memory: 1Gi
            volumeMounts:
            - mountPath: /data
              name: worker-data
            - mountPath: /cache
              name: worker-cache
          initContainers:
          - name: init-worker
            image: busybox:latest
            envFrom:
            - configMapRef:
                name: init-config
          volumes:
          - name: worker-data
            secret:
              secretName: worker-data-secret
          - name: worker-cache
            persistentVolumeClaim:
              claimName: worker-cache-pvc
  submitterPodTemplate:
    spec:
      restartPolicy: Never
      containers:
      - name: ray-job-submitter
        image: rayproject/ray:2.52.0
        envFrom:
        - secretRef:
            name: submitter-secrets
        volumeMounts:
        - mountPath: /config
          name: submitter-config
      volumes:
      - name: submitter-config
        configMap:
          name: submitter-config

