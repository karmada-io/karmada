# test case for aggregating status of ClusterPolicy
# case1. ClusterPolicy with two status items
# case2. ClusterPolicy with different Ready reasons
# case3. ClusterPolicy with nil statusItems

name: "ClusterPolicy with two status items"
description: "Test aggregating status of ClusterPolicy with two status items"
desiredObj:
  apiVersion: kyverno.io/v1
  kind: ClusterPolicy
  metadata:
    name: sample
  spec:
    validationFailureAction: Enforce
    rules:
      - name: require-ns-purpose-label
        match:
          any:
            - resources:
                kinds:
                  - Namespace
        validate:
          message: "You must have label `purpose` with value `production` set on all new namespaces."
          pattern:
            metadata:
              labels:
                purpose: production
statusItems:
  - applied: true
    clusterName: member2
    health: Healthy
    status:
      conditions:
        - lastTransitionTime: "2023-05-07T12:28:58Z"
          message: ""
          reason: Succeeded
          status: "True"
          type: Ready
      ready: true
      rulecount:
        generate: 0
        mutate: 0
        validate: 1
        verifyimages: 0
  - applied: true
    clusterName: member3
    health: Healthy
    status:
      conditions:
        - lastTransitionTime: "2023-05-07T12:28:58Z"
          message: ""
          reason: Succeeded
          status: "True"
          type: Ready
      ready: true
      rulecount:
        generate: 0
        mutate: 0
        validate: 1
        verifyimages: 0
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: sample
    spec:
      validationFailureAction: Enforce
      rules:
        - name: require-ns-purpose-label
          match:
            any:
              - resources:
                  kinds:
                    - Namespace
          validate:
            message: "You must have label `purpose` with value `production` set on all new namespaces."
            pattern:
              metadata:
                labels:
                  purpose: production
    status:
      conditions:
        - type: Ready
          status: "True"
          reason: Succeeded
          lastTransitionTime: "2023-05-07T12:28:58Z"
          message: "member2=, member3="
      ready: true
      rulecount:
        generate: 0
        mutate: 0
        validate: 2
        verifyimages: 0
---
name: "ClusterPolicy with different Ready reasons"
desiredObj:
  apiVersion: kyverno.io/v1
  kind: ClusterPolicy
  metadata:
    name: mixed-reasons
statusItems:
  - clusterName: member1
    status:
      conditions:
        - type: Ready
          status: "True"
          reason: Succeeded
          message: "ok"
  - clusterName: member2
    status:
      conditions:
        - type: Ready
          status: "True"
          reason: Failed
          message: "error"
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: mixed-reasons
    status:
      conditions:
        - type: Ready
          status: "True"
          reason: Succeeded
          message: "member1=ok"
        - type: Ready
          status: "True"
          reason: Failed
          message: "member2=error"
      rulecount:
        generate: 0
        mutate: 0
        validate: 0
        verifyimages: 0
---
name: "ClusterPolicy with nil statusItems"
desiredObj:
  apiVersion: kyverno.io/v1
  kind: ClusterPolicy
  metadata:
    name: no-status
statusItems: null
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: no-status
