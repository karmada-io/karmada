# test case for interpreting health of DaemonSet
# case1. DaemonSet interpreting health test
# case2: Generation mismatch
# case3: Not all updated pods are available
# case4: Not all pods updated
# case5: Zero desired pods

name: "DaemonSet interpreting health test"
description: "Test interpreting health of DaemonSet"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: DaemonSet
  metadata:
    annotations:
      resourcetemplate.karmada.io/generation: "1"
    labels:
      app: sample-daemonset
    name: sample
    namespace: test-kruise-daemonset
    generation: 1
  spec:
    selector:
      matchLabels:
        app: sample-daemonset
    template:
      metadata:
        labels:
          app: sample-daemonset
      spec:
        volumes:
          - name: configmap
            configMap:
              name: my-sample-config
        containers:
          - name: nginx
            image: nginx:alpine
            env:
              - name: logData
                valueFrom:
                  configMapKeyRef:
                    name: mysql-config
                    key: log
              - name: lowerData
                valueFrom:
                  configMapKeyRef:
                    name: mysql-config
                    key: lower
  status:
    currentNumberScheduled: 1
    daemonSetHash: 7dd59cf749
    desiredNumberScheduled: 1
    numberAvailable: 1
    numberMisscheduled: 0
    numberReady: 1
    observedGeneration: 1
    updatedNumberScheduled: 1
operation: InterpretHealth
output:
  healthy: true

---
name: "DaemonSet unhealthy - generation mismatch"
description: "Test InterpretHealth returns false when observedGeneration doesn't match generation"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: DaemonSet
  metadata:
    name: sample
    namespace: test-kruise-daemonset
    generation: 5
  spec:
    selector:
      matchLabels:
        app: sample-daemonset
    template:
      metadata:
        labels:
          app: sample-daemonset
      spec:
        containers:
          - name: nginx
            image: nginx:alpine
  status:
    observedGeneration: 3
    desiredNumberScheduled: 3
    updatedNumberScheduled: 3
    numberAvailable: 3
operation: InterpretHealth
output:
  healthy: false

---
name: "DaemonSet unhealthy - not all updated pods available"
description: "Test InterpretHealth returns false when numberAvailable < updatedNumberScheduled"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: DaemonSet
  metadata:
    name: sample
    namespace: test-kruise-daemonset
    generation: 2
  spec:
    selector:
      matchLabels:
        app: sample-daemonset
    template:
      metadata:
        labels:
          app: sample-daemonset
      spec:
        containers:
          - name: nginx
            image: nginx:alpine
  status:
    observedGeneration: 2
    desiredNumberScheduled: 5
    updatedNumberScheduled: 5
    numberAvailable: 3
operation: InterpretHealth
output:
  healthy: false

---
name: "DaemonSet unhealthy - not all pods updated"
description: "Test InterpretHealth returns false when updatedNumberScheduled < desiredNumberScheduled"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: DaemonSet
  metadata:
    name: sample
    namespace: test-kruise-daemonset
    generation: 2
  spec:
    selector:
      matchLabels:
        app: sample-daemonset
    template:
      metadata:
        labels:
          app: sample-daemonset
      spec:
        containers:
          - name: nginx
            image: nginx:alpine
  status:
    observedGeneration: 2
    desiredNumberScheduled: 5
    updatedNumberScheduled: 3
    numberAvailable: 3
operation: InterpretHealth
output:
  healthy: false

---
name: "DaemonSet healthy - zero desired pods"
description: "Test InterpretHealth returns true when desiredNumberScheduled is 0"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: DaemonSet
  metadata:
    name: sample
    namespace: test-kruise-daemonset
    generation: 1
  spec:
    selector:
      matchLabels:
        app: sample-daemonset
    template:
      metadata:
        labels:
          app: sample-daemonset
      spec:
        containers:
          - name: nginx
            image: nginx:alpine
  status:
    observedGeneration: 1
    desiredNumberScheduled: 0
    updatedNumberScheduled: 0
    numberAvailable: 0
    currentNumberScheduled: 0
    numberReady: 0
operation: InterpretHealth
output:
  healthy: true
