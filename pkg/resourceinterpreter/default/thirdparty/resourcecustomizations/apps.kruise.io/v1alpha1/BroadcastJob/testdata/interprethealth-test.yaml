# test case for interpreting health of BroadcastJob
# case1. BroadcastJob with failed phase should be Unhealthy
# case2. BroadcastJob with desired zero should be Unhealthy
# case3. BroadcastJob with no active and no succeeded should be Unhealthy
# case4. BroadcastJob healthy when active or succeeded exists
name: "BroadcastJob with failed phase should be Unhealthy"
description: "Test interpreting health of BroadcastJob with failed phase"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: BroadcastJob
  metadata:
    labels:
      app: sample
    name: sample
    namespace: test-bcj
  spec:
    parallelism: 1
    template:
      metadata:
        labels:
          app: sample
      spec:
        restartPolicy: Never
        volumes:
          - name: configmap
            configMap:
              name: my-sample-config
        containers:
          - name: nginx
            image: nginx:alpine
            env:
              - name: logData
                valueFrom:
                  configMapKeyRef:
                    name: mysql-config
                    key: log
              - name: lowerData
                valueFrom:
                  configMapKeyRef:
                    name: mysql-config
                    key: lower
    completionPolicy:
      type: Always
      activeDeadlineSeconds: 10
  status:
    active: 0
    completionTime: "2023-04-06T15:01:47Z"
    conditions:
      - lastProbeTime: "2023-04-06T15:01:47Z"
        lastTransitionTime: "2023-04-06T15:01:47Z"
        message: Job test-bcj/sample was active longer than specified deadline
        reason: Failed
        status: "True"
        type: Failed
    desired: 1
    failed: 1
    phase: failed
    startTime: "2023-04-06T15:01:37Z"
    succeeded: 0
operation: InterpretHealth
output:
    health: false
---
name: "BroadcastJob with desired zero should be Unhealthy"
description: "Health should be false when desired is zero"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: BroadcastJob
  metadata:
    name: sample
    namespace: test-bcj
  status:
    desired: 0
    active: 0
    succeeded: 0
    failed: 0
operation: InterpretHealth
output:
  healthy: false
---
name: "BroadcastJob with no active and no succeeded should be Unhealthy"
description: "Health should be false when both active and succeeded are zero"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: BroadcastJob
  metadata:
    name: sample
    namespace: test-bcj
  status:
    desired: 1
    active: 0
    succeeded: 0
    failed: 0
operation: InterpretHealth
output:
  healthy: false
---
name: "BroadcastJob healthy when active or succeeded exists"
description: "Health should be true when job is progressing or succeeded"
observedObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: BroadcastJob
  metadata:
    name: sample
    namespace: test-bcj
  status:
    desired: 1
    active: 1
    succeeded: 0
    failed: 0
operation: InterpretHealth
output:
  healthy: true
