# test case for aggregating status of UnitedDeployment
# case1. UnitedDeployment with two status items
# case2. UnitedDeployment with mixed observed generations
# case3. UnitedDeployment with no status items

name: "UnitedDeployment with two status items"
description: "Test aggregating status of UnitedDeployment with two status items"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: UnitedDeployment
  metadata:
    name: sample-uniteddeployment
    namespace: test-namespace
    generation: 1
  spec:
    replicas: 3
    selector:
      matchLabels:
        app: sample
    template:
      metadata:
        labels:
          app: sample
      spec:
        containers:
          - name: nginx
            image: nginx:latest
            env:
              - name: CONFIG_DATA
                valueFrom:
                  configMapKeyRef:
                    name: app-config
                    key: config
              - name: SECRET_DATA
                valueFrom:
                  secretKeyRef:
                    name: app-secret
                    key: token
            volumeMounts:
              - name: config-volume
                mountPath: /etc/config
        volumes:
          - name: config-volume
            configMap:
              name: app-config
    topologySpread:
      - topologyKey: kubernetes.io/hostname
        maxSkew: 1
statusItems:
  - apiVersion: apps.kruise.io/v1alpha1
    kind: UnitedDeployment
    metadata:
      name: sample-uniteddeployment
      namespace: test-namespace
      clusterName: member1
    status:
      replicas: 2
      readyReplicas: 2
      updatedReplicas: 2
      availableReplicas: 2
      collisionCount: 0
      observedGeneration: 1
      generation: 1
      resourceTemplateGeneration: 1
  - apiVersion: apps.kruise.io/v1alpha1
    kind: UnitedDeployment
    metadata:
      name: sample-uniteddeployment
      namespace: test-namespace
      clusterName: member2
    status:
      replicas: 1
      readyReplicas: 1
      updatedReplicas: 1
      availableReplicas: 1
      collisionCount: 0
      observedGeneration: 1
      generation: 1
      resourceTemplateGeneration: 1
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: UnitedDeployment
    metadata:
      name: sample-uniteddeployment
      namespace: test-namespace
      generation: 1
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: sample
      template:
        metadata:
          labels:
            app: sample
        spec:
          containers:
            - name: nginx
              image: nginx:latest
              env:
                - name: CONFIG_DATA
                  valueFrom:
                    configMapKeyRef:
                      name: app-config
                      key: config
                - name: SECRET_DATA
                  valueFrom:
                    secretKeyRef:
                      name: app-secret
                      key: token
              volumeMounts:
                - name: config-volume
                  mountPath: /etc/config
          volumes:
            - name: config-volume
              configMap:
                name: app-config
      topologySpread:
        - topologyKey: kubernetes.io/hostname
          maxSkew: 1
    status:
      replicas: 3
      readyReplicas: 3
      updatedReplicas: 3
      availableReplicas: 3
      unavailableReplicas: 0
      observedGeneration: 1
---
name: "UnitedDeployment with mixed observed generations"
description: "observedGeneration should not advance if any member is stale"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: UnitedDeployment
  metadata:
    name: sample-uniteddeployment
    namespace: test-namespace
    generation: 2
  status:
    observedGeneration: 1
statusItems:
  - status:
      replicas: 2
      readyReplicas: 2
      updatedReplicas: 2
      availableReplicas: 2
      generation: 2
      observedGeneration: 2
      resourceTemplateGeneration: 2
  - status:
      replicas: 1
      readyReplicas: 1
      updatedReplicas: 1
      availableReplicas: 1
      generation: 2
      observedGeneration: 1
      resourceTemplateGeneration: 2
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: UnitedDeployment
    metadata:
      name: sample-uniteddeployment
      namespace: test-namespace
      generation: 2
    status:
      replicas: 3
      readyReplicas: 3
      updatedReplicas: 3
      availableReplicas: 3
      unavailableReplicas: 0
      observedGeneration: 1
---
name: "UnitedDeployment with no status items"
description: "AggregateStatus should initialize empty status"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: UnitedDeployment
  metadata:
    name: sample-uniteddeployment
    namespace: test-namespace
    generation: 1
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: UnitedDeployment
    metadata:
      name: sample-uniteddeployment
      namespace: test-namespace
      generation: 1
    status:
      replicas: 0
      readyReplicas: 0
      updatedReplicas: 0
      availableReplicas: 0
      unavailableReplicas: 0
      observedGeneration: 1
