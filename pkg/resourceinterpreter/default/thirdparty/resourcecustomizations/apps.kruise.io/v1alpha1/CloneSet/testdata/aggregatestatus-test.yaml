# test cases for aggregating status of CloneSet
# case1. CloneSet with two status items
# case2. CloneSet with partially ready replicas
# case3. CloneSet with mixed observed generations
# case4. CloneSet with no status items

# Case 1:
name: "CloneSet with two status items"
description: "Test aggregating status of CloneSet with two status items"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: CloneSet
  metadata:
    labels:
      app: sample
    name: sample
    namespace: test-cloneset
    generation: 1
statusItems:
  - applied: true
    clusterName: member1
    health: Healthy
    status:
      availableReplicas: 2
      currentRevision: sample-59df6bd888
      expectedUpdatedReplicas: 2
      labelSelector: app=sample,test=cloneset
      observedGeneration: 1
      readyReplicas: 2
      replicas: 2
      updateRevision: sample-59df6bd888
      updatedReadyReplicas: 2
      updatedReplicas: 2
      generation: 1
      resourceTemplateGeneration: 1
  - applied: true
    clusterName: member3
    health: Healthy
    status:
      availableReplicas: 2
      currentRevision: sample-59df6bd888
      expectedUpdatedReplicas: 2
      labelSelector: app=sample,test=cloneset
      observedGeneration: 1
      readyReplicas: 2
      replicas: 2
      updateRevision: sample-59df6bd888
      updatedReadyReplicas: 2
      updatedReplicas: 2
      generation: 1
      resourceTemplateGeneration: 1
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: CloneSet
    metadata:
      labels:
        app: sample
      name: sample
      namespace: test-cloneset
      generation: 1
    status:
      replicas: 4
      readyReplicas: 4
      availableReplicas: 4
      updatedReplicas: 4
      updatedReadyReplicas: 4
      expectedUpdatedReplicas: 4
      observedGeneration: 1
      currentRevision: sample-59df6bd888
      updateRevision: sample-59df6bd888
      labelSelector: app=sample,test=cloneset
---
# Case 2:
name: "CloneSet with partially ready replicas"
description: "AggregateStatus when some replicas are not ready"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: CloneSet
  metadata:
    name: sample
    namespace: test-cloneset
    generation: 2
  spec:
    replicas: 4
statusItems:
  - applied: true
    clusterName: member1
    status:
      replicas: 2
      readyReplicas: 1
      availableReplicas: 1
      updatedReplicas: 2
      updatedReadyReplicas: 1
      expectedUpdatedReplicas: 2
      generation: 2
      observedGeneration: 2
      resourceTemplateGeneration: 2
  - applied: true
    clusterName: member2
    status:
      replicas: 2
      readyReplicas: 2
      availableReplicas: 2
      updatedReplicas: 2
      updatedReadyReplicas: 2
      expectedUpdatedReplicas: 2
      generation: 2
      observedGeneration: 2
      resourceTemplateGeneration: 2
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: CloneSet
    metadata:
      name: sample
      namespace: test-cloneset
      generation: 2
    spec:
      replicas: 4
    status:
      replicas: 4
      readyReplicas: 3
      availableReplicas: 3
      updatedReplicas: 4
      updatedReadyReplicas: 3
      expectedUpdatedReplicas: 4
      observedGeneration: 2
      currentRevision: ''
      updateRevision: ''
      labelSelector: ''
---
# Case 3:
name: "CloneSet with mixed observed generations"
description: "AggregateStatus should not update observedGeneration if any member is stale"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: CloneSet
  metadata:
    name: sample
    namespace: test-cloneset
    generation: 3
  status:
    observedGeneration: 2
statusItems:
  - applied: true
    clusterName: member1
    status:
      replicas: 2
      readyReplicas: 2
      generation: 3
      observedGeneration: 3
      resourceTemplateGeneration: 3
  - applied: true
    clusterName: member2
    status:
      replicas: 2
      readyReplicas: 2
      generation: 3
      observedGeneration: 2   
      resourceTemplateGeneration: 3
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: CloneSet
    metadata:
      name: sample
      namespace: test-cloneset
      generation: 3
    status:
      replicas: 4
      readyReplicas: 4
      availableReplicas: 0
      updatedReplicas: 0
      updatedReadyReplicas: 0
      expectedUpdatedReplicas: 0
      observedGeneration: 2
      currentRevision: ''
      updateRevision: ''
      labelSelector: ''
---
# Case 4:
name: "CloneSet with no status items"
description: "AggregateStatus when CloneSet is not propagated"
desiredObj:
  apiVersion: apps.kruise.io/v1alpha1
  kind: CloneSet
  metadata:
    name: sample
    namespace: test-cloneset
    generation: 1
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: apps.kruise.io/v1alpha1
    kind: CloneSet
    metadata:
      name: sample
      namespace: test-cloneset
      generation: 1
    status:
      replicas: 0
      readyReplicas: 0
      availableReplicas: 0
      updatedReplicas: 0
      updatedReadyReplicas: 0
      expectedUpdatedReplicas: 0
      observedGeneration: 1
