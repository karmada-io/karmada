# test case for interpreting status of HelmRepository
# case1. HelmRepository: interpret status test
# case2. HelmRepository with nil status
# case3. HelmRepository without resourceTemplateGeneration annotation
# case4. HelmRepository with non-numeric resourceTemplateGeneration
# case5. HelmRepository without conditions

name: "HelmRepository: interpret status test"
description: "Test interpreting status for HelmRepository"
observedObj:
  apiVersion: source.toolkit.fluxcd.io/v1beta2
  kind: HelmRepository
  metadata:
    annotations:
      resourcetemplate.karmada.io/generation: "1"
    name: podinfo
    namespace: test-helmrepository
    generation: 1
  spec:
    interval: 5m0s
    provider: generic
    timeout: 60s
    url: https://stefanprodan.github.io/podinfo
    secretRef:
      name: fake-secret
    suspend: true
  status:
    artifact:
      digest: sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69
      lastUpdateTime: "2023-04-29T09:30:31Z"
      path: helmrepository/test-helmrepository/sample/index-61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69.yaml
      revision: sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69
      size: 42012
      url: http://source-controller.flux-system.svc.cluster.local./helmrepository/test-helmrepository/sample/index-61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69.yaml
    conditions:
      - lastTransitionTime: "2023-04-29T09:30:31Z"
        message: 'stored artifact: revision ''sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69'''
        observedGeneration: 1
        reason: Succeeded
        status: "True"
        type: Ready
      - lastTransitionTime: "2023-04-29T09:30:31Z"
        message: 'stored artifact: revision ''sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69'''
        observedGeneration: 1
        reason: Succeeded
        status: "True"
        type: ArtifactInStorage
    observedGeneration: 1
    url: http://source-controller.flux-system.svc.cluster.local./helmrepository/test-helmrepository/sample/index.yaml
operation: InterpretStatus
output:
  status:
    artifact:
      digest: sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69
      lastUpdateTime: "2023-04-29T09:30:31Z"
      path: helmrepository/test-helmrepository/sample/index-61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69.yaml
      revision: sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69
      size: 42012
      url: http://source-controller.flux-system.svc.cluster.local./helmrepository/test-helmrepository/sample/index-61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69.yaml
    conditions:
      - lastTransitionTime: "2023-04-29T09:30:31Z"
        message: "stored artifact: revision 'sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69'"
        observedGeneration: 1
        reason: Succeeded
        status: "True"
        type: Ready
      - lastTransitionTime: "2023-04-29T09:30:31Z"
        message: "stored artifact: revision 'sha256:61f94c20ee9417f222c3d30672724473ae50d406c8c097d80a8a6263c1384f69'"
        observedGeneration: 1
        reason: Succeeded
        status: "True"
        type: ArtifactInStorage
    observedGeneration: 1
    url: http://source-controller.flux-system.svc.cluster.local./helmrepository/test-helmrepository/sample/index.yaml
    generation: 1
    resourceTemplateGeneration: 1
---
name: "HelmRepository with nil status"
description: "InterpretStatus should return empty status when status is nil"
observedObj:
  apiVersion: source.toolkit.fluxcd.io/v1beta2
  kind: HelmRepository
  metadata:
    name: podinfo
    namespace: test-helmrepository
operation: InterpretStatus
output:
  status: {}
---
name: "HelmRepository without resourceTemplateGeneration annotation"
description: "resourceTemplateGeneration should be absent when annotation is missing"
observedObj:
  apiVersion: source.toolkit.fluxcd.io/v1beta2
  kind: HelmRepository
  metadata:
    name: podinfo
    namespace: test-helmrepository
    generation: 2
  status:
    observedGeneration: 2
operation: InterpretStatus
output:
  status:
    observedGeneration: 2
    generation: 2
---
name: "HelmRepository with non-numeric resourceTemplateGeneration"
description: "resourceTemplateGeneration should be parsed when annotation is a numeric string"
observedObj:
  apiVersion: source.toolkit.fluxcd.io/v1beta2
  kind: HelmRepository
  metadata:
    name: podinfo
    namespace: test-helmrepository
    generation: 4
    annotations:
      resourcetemplate.karmada.io/generation: "123"  
  status:
    observedGeneration: 4
operation: InterpretStatus
output:
  status:
    observedGeneration: 4
    generation: 4
    resourceTemplateGeneration: 123
---
name: "HelmRepository without conditions"
description: "InterpretStatus should work when conditions are missing"
observedObj:
  apiVersion: source.toolkit.fluxcd.io/v1beta2
  kind: HelmRepository
  metadata:
    name: podinfo
    namespace: test-helmrepository
    generation: 3
  status:
    artifact:
      revision: sha256:test
operation: InterpretStatus
output:
  status:
    artifact:
      revision: sha256:test
    generation: 3
