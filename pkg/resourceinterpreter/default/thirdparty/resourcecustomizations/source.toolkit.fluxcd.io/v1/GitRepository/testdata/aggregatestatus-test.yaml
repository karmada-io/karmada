# test case for aggregating status of GitRepository
# case1. GitRepository with two status items
# case2. GitRepository with stale member
# case3. GitRepository with no status items
# case4. GitRepository with different artifacts picks last one
# case5. GitRepository condition merging with different reasons

name: "GitRepository with two status items"
description: "Test aggregating status of GitRepository with two status items"
desiredObj:
  apiVersion: source.toolkit.fluxcd.io/v1
  kind: GitRepository
  metadata:
    generation: 1
    name: sample
    namespace: test-gitrepository
  spec:
    interval: 30s
    ref:
      branch: master
    url: https://github.com/stefanprodan/podinfo
statusItems:
  - applied: true
    clusterName: member1
    health: Healthy
    status:
      artifact:
        digest: sha256:a375b2ca68275734e3850d3c80e0bc20c1d7a4daa1a9717056d5c0c563ea0719
        lastUpdateTime: "2023-05-01T10:17:09Z"
        path: gitrepository/test-gitrepository/sample/0647aea75b85755411b007a290b9321668370be5.tar.gz
        revision: master@sha1:0647aea75b85755411b007a290b9321668370be5
        size: 83516
        url: http://source-controller.flux-system.svc.cluster.local./gitrepository/test-gitrepository/sample/0647aea75b85755411b007a290b9321668370be5.tar.gz
      conditions:
        - lastTransitionTime: "2023-05-01T10:17:09Z"
          message: stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5'
          observedGeneration: 1
          reason: Succeeded
          status: "True"
          type: Ready
        - lastTransitionTime: "2023-05-01T10:17:09Z"
          message: stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5'
          observedGeneration: 1
          reason: Succeeded
          status: "True"
          type: ArtifactInStorage
      generation: 1
      observedGeneration: 1
      resourceTemplateGeneration: 1
  - applied: true
    clusterName: member3
    health: Healthy
    status:
      artifact:
        digest: sha256:a375b2ca68275734e3850d3c80e0bc20c1d7a4daa1a9717056d5c0c563ea0719
        lastUpdateTime: "2023-05-01T10:17:08Z"
        path: gitrepository/test-gitrepository/sample/0647aea75b85755411b007a290b9321668370be5.tar.gz
        revision: master@sha1:0647aea75b85755411b007a290b9321668370be5
        size: 83516
        url: http://source-controller.flux-system.svc.cluster.local./gitrepository/test-gitrepository/sample/0647aea75b85755411b007a290b9321668370be5.tar.gz
      conditions:
        - lastTransitionTime: "2023-05-01T10:17:08Z"
          message: stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5'
          observedGeneration: 1
          reason: Succeeded
          status: "True"
          type: Ready
        - lastTransitionTime: "2023-05-01T10:17:08Z"
          message: stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5'
          observedGeneration: 1
          reason: Succeeded
          status: "True"
          type: ArtifactInStorage
      generation: 1
      observedGeneration: 1
      resourceTemplateGeneration: 1
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    metadata:
      generation: 1
      name: sample
      namespace: test-gitrepository
    spec:
      interval: 30s
      ref:
        branch: master
      url: https://github.com/stefanprodan/podinfo
    status:
      artifact:
        digest: sha256:a375b2ca68275734e3850d3c80e0bc20c1d7a4daa1a9717056d5c0c563ea0719
        lastUpdateTime: "2023-05-01T10:17:08Z"
        path: gitrepository/test-gitrepository/sample/0647aea75b85755411b007a290b9321668370be5.tar.gz
        revision: master@sha1:0647aea75b85755411b007a290b9321668370be5
        size: 83516
        url: http://source-controller.flux-system.svc.cluster.local./gitrepository/test-gitrepository/sample/0647aea75b85755411b007a290b9321668370be5.tar.gz
      conditions:
      - type: Ready
        status: "True"
        reason: Succeeded
        lastTransitionTime: "2023-05-01T10:17:09Z"
        message: member1=stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5', member3=stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5'
        observedGeneration: 1
      - type: ArtifactInStorage
        status: "True"
        reason: Succeeded
        lastTransitionTime: "2023-05-01T10:17:09Z"
        message: member1=stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5', member3=stored artifact for revision 'master@sha1:0647aea75b85755411b007a290b9321668370be5'
        observedGeneration: 1
      observedGeneration: 1
---
name: "GitRepository with stale member"
description: "observedGeneration should not advance if any member is stale"
desiredObj:
  apiVersion: source.toolkit.fluxcd.io/v1
  kind: GitRepository
  metadata:
    generation: 2
    name: sample
    namespace: test-gitrepository
  status:
    observedGeneration: 1
statusItems:
  - status:
      generation: 2
      observedGeneration: 2
      resourceTemplateGeneration: 2
  - status:
      generation: 2
      observedGeneration: 1
      resourceTemplateGeneration: 2
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    metadata:
      generation: 2
      name: sample
      namespace: test-gitrepository
    status:
      observedGeneration: 1
---
name: "GitRepository with no status items"
description: "AggregateStatus should initialize empty status"
desiredObj:
  apiVersion: source.toolkit.fluxcd.io/v1
  kind: GitRepository
  metadata:
    generation: 3
    name: sample
    namespace: test-gitrepository
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    metadata:
      generation: 3
      name: sample
      namespace: test-gitrepository
    status:
      observedGeneration: 3
---
name: "GitRepository with different artifacts picks last one"
description: "AggregateStatus should pick the last artifact when members report different revisions"
desiredObj:
  apiVersion: source.toolkit.fluxcd.io/v1
  kind: GitRepository
  metadata:
    generation: 1
    name: sample
    namespace: test-gitrepository
statusItems:
  - clusterName: member1
    status:
      artifact:
        revision: master@sha1:aaaa1111
        path: artifact-a.tar.gz
  - clusterName: member2
    status:
      artifact:
        revision: master@sha1:bbbb2222
        path: artifact-b.tar.gz
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    metadata:
      generation: 1
      name: sample
      namespace: test-gitrepository
    status:
      artifact:
        revision: master@sha1:bbbb2222
        path: artifact-b.tar.gz
      observedGeneration: 0
---
name: "GitRepository condition merging with different reasons"
description: "Conditions with same type but different reasons should not be merged"
desiredObj:
  apiVersion: source.toolkit.fluxcd.io/v1
  kind: GitRepository
  metadata:
    name: sample
    namespace: test-gitrepository
statusItems:
  - clusterName: member1
    status:
      conditions:
        - type: Ready
          status: "True"
          reason: Succeeded
          message: ok
  - clusterName: member2
    status:
      conditions:
        - type: Ready
          status: "False"
          reason: Failed
          message: error
operation: AggregateStatus
output:
  aggregatedStatus:
    apiVersion: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    metadata:
      generation: 0
      name: sample
      namespace: test-gitrepository
    status:
      conditions:
        - type: Ready
          status: "True"
          reason: Succeeded
          message: member1=ok
        - type: Ready
          status: "False"
          reason: Failed
          message: member2=error
      observedGeneration: 0
